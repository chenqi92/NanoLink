name: CI/CD Pipeline

# ç»Ÿä¸€çš„ CI/CD å…¥å£
# - Tag Push / VERSION å˜æ›´ï¼šå…¨éƒ¨æµ‹è¯• + å…¨éƒ¨å‘å¸ƒ
# - PRï¼šå…¨éƒ¨æµ‹è¯•ï¼Œä¸å‘å¸ƒ
# - æ‰‹åŠ¨ï¼šé€‰æ‹©ç»„ä»¶æµ‹è¯• + é€‰æ‹©æ˜¯å¦å‘å¸ƒ + é€‰æ‹©å‘å¸ƒç»„ä»¶

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      # æµ‹è¯•é€‰é¡¹
      test_agent:
        description: "Test Agent"
        type: boolean
        default: true
      test_sdk:
        description: "Test SDK (Java/Go/Python)"
        type: boolean
        default: true
      test_apps:
        description: "Test Apps (Dashboard)"
        type: boolean
        default: true
      # å‘å¸ƒé€‰é¡¹ (å‹¾é€‰ä»»æ„ä¸€ä¸ªå³å¯ç”¨å‘å¸ƒæ¨¡å¼)
      release_agent:
        description: "Release Agent (check to enable)"
        type: boolean
        default: false
      release_sdk:
        description: "Release SDK (check to enable)"
        type: boolean
        default: false
      release_apps:
        description: "Release Apps (check to enable)"
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ============================================================
  # Setup: ç¡®å®šè¿è¡Œæ¨¡å¼å’Œé…ç½®
  # ============================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.mode.outputs.is_release }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      test_agent: ${{ steps.config.outputs.test_agent }}
      test_sdk: ${{ steps.config.outputs.test_sdk }}
      test_apps: ${{ steps.config.outputs.test_apps }}
      release_agent: ${{ steps.config.outputs.release_agent }}
      release_sdk: ${{ steps.config.outputs.release_sdk }}
      release_apps: ${{ steps.config.outputs.release_apps }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine mode
        id: mode
        run: |
          # Tag push = è‡ªåŠ¨å‘å¸ƒæ¨¡å¼
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Release mode: Tag push detected"
          # PR æ¨¡å¼ï¼šæ°¸ä¸å‘å¸ƒ
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "ðŸ” PR mode: Test only, no release"
          else
            # æ‰‹åŠ¨æ¨¡å¼ï¼šå¦‚æžœå‹¾é€‰äº†ä»»æ„ release_xxxï¼Œåˆ™å¯ç”¨å‘å¸ƒæ¨¡å¼
            RELEASE_AGENT="${{ github.event.inputs.release_agent }}"
            RELEASE_SDK="${{ github.event.inputs.release_sdk }}"
            RELEASE_APPS="${{ github.event.inputs.release_apps }}"
            
            if [[ "$RELEASE_AGENT" == "true" ]] || \
               [[ "$RELEASE_SDK" == "true" ]] || \
               [[ "$RELEASE_APPS" == "true" ]]; then
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "ðŸš€ Release mode: Manual release enabled"
            else
              echo "is_release=false" >> $GITHUB_OUTPUT
              echo "ðŸ”§ Test only mode"
            fi
          fi

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG="${GITHUB_REF#refs/tags/}"
          else
            VERSION=$(cat VERSION | tr -d '[:space:]')
            TAG="v$VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG"

      - name: Configure what to test/release
        id: config
        run: |
          # Tag push æ¨¡å¼ï¼šå…¨éƒ¨æµ‹è¯•å’Œå‘å¸ƒ
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "test_agent=true" >> $GITHUB_OUTPUT
            echo "test_sdk=true" >> $GITHUB_OUTPUT
            echo "test_apps=true" >> $GITHUB_OUTPUT
            echo "release_agent=true" >> $GITHUB_OUTPUT
            echo "release_sdk=true" >> $GITHUB_OUTPUT
            echo "release_apps=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Auto release mode: All components will be tested and released"
          # PR æ¨¡å¼ï¼šå…¨éƒ¨æµ‹è¯•ï¼Œä¸å‘å¸ƒ
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "test_agent=true" >> $GITHUB_OUTPUT
            echo "test_sdk=true" >> $GITHUB_OUTPUT
            echo "test_apps=true" >> $GITHUB_OUTPUT
            echo "release_agent=false" >> $GITHUB_OUTPUT
            echo "release_sdk=false" >> $GITHUB_OUTPUT
            echo "release_apps=false" >> $GITHUB_OUTPUT
            echo "ðŸ” PR mode: All components will be tested, no release"
          # æ‰‹åŠ¨æ¨¡å¼ï¼šä½¿ç”¨è¾“å…¥å‚æ•°
          else
            echo "test_agent=${{ github.event.inputs.test_agent || 'true' }}" >> $GITHUB_OUTPUT
            echo "test_sdk=${{ github.event.inputs.test_sdk || 'true' }}" >> $GITHUB_OUTPUT
            echo "test_apps=${{ github.event.inputs.test_apps || 'true' }}" >> $GITHUB_OUTPUT
            echo "release_agent=${{ github.event.inputs.release_agent || 'true' }}" >> $GITHUB_OUTPUT
            echo "release_sdk=${{ github.event.inputs.release_sdk || 'true' }}" >> $GITHUB_OUTPUT
            echo "release_apps=${{ github.event.inputs.release_apps || 'true' }}" >> $GITHUB_OUTPUT
            echo "ðŸ–±ï¸ Manual mode: Using input parameters"
          fi

      - name: Summary
        run: |
          echo "## Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Mode | ${{ steps.mode.outputs.is_release }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Agent | ${{ steps.config.outputs.test_agent }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test SDK | ${{ steps.config.outputs.test_sdk }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Apps | ${{ steps.config.outputs.test_apps }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Agent | ${{ steps.config.outputs.release_agent }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release SDK | ${{ steps.config.outputs.release_sdk }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Apps | ${{ steps.config.outputs.release_apps }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # Test: Agent
  # ============================================================
  test-agent:
    name: Test Agent (${{ matrix.os }})
    needs: setup
    if: needs.setup.outputs.test_agent == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        run: choco install protoc

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            agent/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        working-directory: agent
        run: cargo fmt --all -- --check

      - name: Clippy
        working-directory: agent
        run: cargo clippy -- -D warnings -A clippy::large_enum_variant -A clippy::field_reassign_with_default -A clippy::manual_clamp -A clippy::lines_filter_map_ok -A clippy::empty_line_after_doc_comments -A clippy::collapsible_if -A dead_code -A unused_imports -A unused_variables -A unused_assignments

      - name: Run tests
        working-directory: agent
        run: cargo test --verbose

      - name: Build
        working-directory: agent
        run: cargo build --release

  # Agent æµ‹è¯•æ±‡æ€»
  test-agent-summary:
    name: Agent Test Summary
    needs: [setup, test-agent]
    if: always() && needs.setup.outputs.test_agent == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.check.outputs.success }}
    steps:
      - name: Check results
        id: check
        run: |
          if [[ "${{ needs.test-agent.result }}" == "success" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Agent tests passed"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Agent tests failed: ${{ needs.test-agent.result }}"
          fi

  # ============================================================
  # Test: Java SDK
  # ============================================================
  test-java-sdk:
    name: Test Java SDK
    needs: setup
    if: needs.setup.outputs.test_sdk == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11"
          cache: "maven"

      - name: Build and test
        working-directory: sdk/java
        run: mvn clean verify

  # ============================================================
  # Test: Go SDK
  # ============================================================
  test-go-sdk:
    name: Test Go SDK
    needs: setup
    if: needs.setup.outputs.test_sdk == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true
          cache-dependency-path: sdk/go/go.sum

      - name: Verify and download dependencies
        working-directory: sdk/go
        run: |
          go mod tidy
          go mod download

      - name: Build
        working-directory: sdk/go
        run: go build ./...

      - name: Test
        working-directory: sdk/go
        run: go test ./...

  # ============================================================
  # Test: Python SDK
  # ============================================================
  test-python-sdk:
    name: Test Python SDK (${{ matrix.python-version }})
    needs: setup
    if: needs.setup.outputs.test_sdk == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: sdk/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint with ruff
        working-directory: sdk/python
        run: ruff check . || true

      - name: Check formatting with black
        working-directory: sdk/python
        run: black --check . || true

      - name: Regenerate proto files
        working-directory: sdk/python
        run: |
          python -m grpc_tools.protoc \
            --proto_path=../protocol \
            --python_out=nanolink/proto \
            --grpc_python_out=nanolink/proto \
            ../protocol/nanolink.proto

      - name: Run tests
        working-directory: sdk/python
        run: pytest tests/ -v

  # SDK æµ‹è¯•æ±‡æ€»
  test-sdk-summary:
    name: SDK Test Summary
    needs: [setup, test-java-sdk, test-go-sdk, test-python-sdk]
    if: always() && needs.setup.outputs.test_sdk == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.check.outputs.success }}
    steps:
      - name: Check results
        id: check
        run: |
          if [[ "${{ needs.test-java-sdk.result }}" == "success" && \
                "${{ needs.test-go-sdk.result }}" == "success" && \
                "${{ needs.test-python-sdk.result }}" == "success" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… All SDK tests passed"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ SDK tests failed"
            echo "  Java: ${{ needs.test-java-sdk.result }}"
            echo "  Go: ${{ needs.test-go-sdk.result }}"
            echo "  Python: ${{ needs.test-python-sdk.result }}"
          fi

  # ============================================================
  # Test: Apps (Dashboard)
  # ============================================================
  test-apps:
    name: Test Dashboard
    needs: setup
    if: needs.setup.outputs.test_apps == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: dashboard
        run: npm install

      - name: Lint
        working-directory: dashboard
        run: npm run lint || true

      - name: Build
        working-directory: dashboard
        run: npm run build

  # Apps æµ‹è¯•æ±‡æ€»
  test-apps-summary:
    name: Apps Test Summary
    needs: [setup, test-apps]
    if: always() && needs.setup.outputs.test_apps == 'true'
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.check.outputs.success }}
    steps:
      - name: Check results
        id: check
        run: |
          if [[ "${{ needs.test-apps.result }}" == "success" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Apps tests passed"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Apps tests failed: ${{ needs.test-apps.result }}"
          fi

  # ============================================================
  # Release: Agent
  # ============================================================
  release-agent:
    name: Release Agent
    needs: [setup, test-agent-summary]
    if: |
      always() &&
      needs.setup.outputs.is_release == 'true' &&
      needs.setup.outputs.release_agent == 'true' &&
      (needs.test-agent-summary.outputs.success == 'true' || needs.setup.outputs.test_agent != 'true')
    uses: ./.github/workflows/release.yml
    with:
      skip_tests: true
    secrets: inherit

  # ============================================================
  # Release: SDK
  # ============================================================
  release-sdk:
    name: Release SDK
    needs: [setup, test-sdk-summary]
    if: |
      always() &&
      needs.setup.outputs.is_release == 'true' &&
      needs.setup.outputs.release_sdk == 'true' &&
      (needs.test-sdk-summary.outputs.success == 'true' || needs.setup.outputs.test_sdk != 'true')
    uses: ./.github/workflows/sdk-release.yml
    with:
      skip_tests: true
    secrets: inherit

  # ============================================================
  # Release: Apps
  # ============================================================
  release-apps:
    name: Release Apps
    needs: [setup, test-apps-summary]
    if: |
      always() &&
      needs.setup.outputs.is_release == 'true' &&
      needs.setup.outputs.release_apps == 'true' &&
      (needs.test-apps-summary.outputs.success == 'true' || needs.setup.outputs.test_apps != 'true')
    uses: ./.github/workflows/apps-release.yml
    with:
      skip_tests: true
    secrets: inherit

  # ============================================================
  # Final Summary
  # ============================================================
  summary:
    name: Pipeline Summary
    needs: [setup, test-agent-summary, test-sdk-summary, test-apps-summary, release-agent, release-sdk, release-apps]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Mode:** ${{ needs.setup.outputs.is_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.setup.outputs.test_agent }}" == "true" ]]; then
            if [[ "${{ needs.test-agent-summary.outputs.success }}" == "true" ]]; then
              echo "| Agent | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Agent | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Agent | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.setup.outputs.test_sdk }}" == "true" ]]; then
            if [[ "${{ needs.test-sdk-summary.outputs.success }}" == "true" ]]; then
              echo "| SDK | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| SDK | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| SDK | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.setup.outputs.test_apps }}" == "true" ]]; then
            if [[ "${{ needs.test-apps-summary.outputs.success }}" == "true" ]]; then
              echo "| Apps | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Apps | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Apps | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.setup.outputs.is_release }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Release Results" >> $GITHUB_STEP_SUMMARY
            echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ needs.setup.outputs.release_agent }}" == "true" ]]; then
              if [[ "${{ needs.release-agent.result }}" == "success" ]]; then
                echo "| Agent | âœ… Released |" >> $GITHUB_STEP_SUMMARY
              elif [[ "${{ needs.release-agent.result }}" == "skipped" ]]; then
                echo "| Agent | â­ï¸ Skipped (test failed) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Agent | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            if [[ "${{ needs.setup.outputs.release_sdk }}" == "true" ]]; then
              if [[ "${{ needs.release-sdk.result }}" == "success" ]]; then
                echo "| SDK | âœ… Released |" >> $GITHUB_STEP_SUMMARY
              elif [[ "${{ needs.release-sdk.result }}" == "skipped" ]]; then
                echo "| SDK | â­ï¸ Skipped (test failed) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| SDK | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            if [[ "${{ needs.setup.outputs.release_apps }}" == "true" ]]; then
              if [[ "${{ needs.release-apps.result }}" == "success" ]]; then
                echo "| Apps | âœ… Released |" >> $GITHUB_STEP_SUMMARY
              elif [[ "${{ needs.release-apps.result }}" == "skipped" ]]; then
                echo "| Apps | â­ï¸ Skipped (test failed) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Apps | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
