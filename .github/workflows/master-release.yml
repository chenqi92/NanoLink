name: Master Release

# This is the main entry point for releases
# It runs tests first, then triggers all release workflows

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release_agent:
        description: "Release Agent"
        type: boolean
        default: true
      release_sdk:
        description: "Release SDK"
        type: boolean
        default: true
      release_apps:
        description: "Release Apps"
        type: boolean
        default: true

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # Step 1: Run all tests first
  run-tests:
    name: Run Tests
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Step 2: Trigger Agent release (only if tests pass)
  release-agent:
    name: Release Agent
    needs: run-tests
    if: |
      needs.run-tests.outputs.success == 'true' && 
      (github.event_name == 'push' || github.event.inputs.release_agent == 'true')
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      skip_tests: true

  # Step 3: Trigger SDK release (only if tests pass)
  release-sdk:
    name: Release SDK
    needs: run-tests
    if: |
      needs.run-tests.outputs.success == 'true' && 
      (github.event_name == 'push' || github.event.inputs.release_sdk == 'true')
    uses: ./.github/workflows/sdk-release.yml
    secrets: inherit
    with:
      skip_tests: true

  # Step 4: Trigger Apps release (only if tests pass)
  release-apps:
    name: Release Apps
    needs: run-tests
    if: |
      needs.run-tests.outputs.success == 'true' && 
      (github.event_name == 'push' || github.event.inputs.release_apps == 'true')
    uses: ./.github/workflows/apps-release.yml
    secrets: inherit
    with:
      skip_tests: true
