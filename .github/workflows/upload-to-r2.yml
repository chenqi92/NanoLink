name: Upload to Cloudflare R2

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š0.1.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      # å®‰è£…è„šæœ¬
      upload_install_scripts:
        description: 'ä¸Šä¼ å®‰è£…è„šæœ¬ (install.sh, install.ps1)'
        required: false
        type: boolean
        default: true
      # Agent äºŒè¿›åˆ¶æ–‡ä»¶
      upload_agent_linux_x64:
        description: 'ä¸Šä¼  Agent Linux x86_64'
        required: false
        type: boolean
        default: true
      upload_agent_linux_arm64:
        description: 'ä¸Šä¼  Agent Linux ARM64'
        required: false
        type: boolean
        default: true
      upload_agent_macos_x64:
        description: 'ä¸Šä¼  Agent macOS Intel (x86_64)'
        required: false
        type: boolean
        default: true
      upload_agent_macos_arm64:
        description: 'ä¸Šä¼  Agent macOS Apple Silicon (ARM64)'
        required: false
        type: boolean
        default: true
      upload_agent_windows_x64:
        description: 'ä¸Šä¼  Agent Windows x64'
        required: false
        type: boolean
        default: true
      # å…¶ä»–é€‰é¡¹
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜Žï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æŽ¥ï¼‰'
        required: false
        type: boolean
        default: true

  # æ”¯æŒè¢«å…¶ä»– workflow è°ƒç”¨
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š0.1.0ï¼Œä¸éœ€è¦ v å‰ç¼€ï¼‰'
        required: true
        type: string
      # å®‰è£…è„šæœ¬
      upload_install_scripts:
        description: 'ä¸Šä¼ å®‰è£…è„šæœ¬ (install.sh, install.ps1)'
        required: false
        type: boolean
        default: true
      # Agent äºŒè¿›åˆ¶æ–‡ä»¶
      upload_agent_linux_x64:
        description: 'ä¸Šä¼  Agent Linux x86_64'
        required: false
        type: boolean
        default: true
      upload_agent_linux_arm64:
        description: 'ä¸Šä¼  Agent Linux ARM64'
        required: false
        type: boolean
        default: true
      upload_agent_macos_x64:
        description: 'ä¸Šä¼  Agent macOS Intel (x86_64)'
        required: false
        type: boolean
        default: true
      upload_agent_macos_arm64:
        description: 'ä¸Šä¼  Agent macOS Apple Silicon (ARM64)'
        required: false
        type: boolean
        default: true
      upload_agent_windows_x64:
        description: 'ä¸Šä¼  Agent Windows x64'
        required: false
        type: boolean
        default: true
      # å…¶ä»–é€‰é¡¹
      update_release_notes:
        description: 'æ›´æ–° Release è¯´æ˜Žï¼ˆæ·»åŠ  R2 ä¸‹è½½é“¾æŽ¥ï¼‰'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify AWS CLI
        run: |
          echo "ðŸ“¦ Verifying AWS CLI installation..."
          aws --version
          echo "âœ… AWS CLI is ready"

      - name: Configure AWS CLI for Cloudflare R2
        run: |
          echo "ðŸ”§ Configuring AWS CLI for Cloudflare R2..."
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto
          echo "âœ… AWS CLI configured"

      - name: Prepare upload directory
        run: |
          echo "ðŸ“ Creating upload directory..."
          mkdir -p ./r2-upload
          echo "âœ… Upload directory created"

      - name: Create R2 install scripts
        if: inputs.upload_install_scripts == true
        run: |
          echo "ðŸ“œ Creating install scripts with R2 download URLs..."
          VERSION="${{ inputs.version }}"
          R2_DOWNLOAD_URL="https://agent.download.kkape.com"
          
          # Create install.sh with R2 download URL (modified version)
          if [ -f "agent/scripts/install.sh" ]; then
            # Replace GitHub download URL with R2 URL
            sed -e "s|https://github.com/\${GITHUB_REPO}/releases/latest/download/\${BINARY_NAME}-\${OS}-\${ARCH}|${R2_DOWNLOAD_URL}/releases/v${VERSION}/\${BINARY_NAME}-\${OS}-\${ARCH}|g" \
                -e "s|https://github.com/chenqi92/NanoLink/releases/latest/download/|${R2_DOWNLOAD_URL}/releases/v${VERSION}/|g" \
                agent/scripts/install.sh > ./r2-upload/install.sh
            chmod +x ./r2-upload/install.sh
            echo "âœ… Created install.sh with R2 download URL"
          else
            echo "âš ï¸ install.sh not found"
          fi
          
          # Create install.ps1 with R2 download URL (modified version)
          if [ -f "agent/scripts/install.ps1" ]; then
            # Replace GitHub download URL with R2 URL
            sed -e "s|https://github.com/\$Script:GitHubRepo/releases/latest/download/nanolink-agent-windows-\$arch.exe|${R2_DOWNLOAD_URL}/releases/v${VERSION}/nanolink-agent-windows-\$arch.exe|g" \
                -e "s|https://github.com/chenqi92/NanoLink/releases/latest/download/|${R2_DOWNLOAD_URL}/releases/v${VERSION}/|g" \
                agent/scripts/install.ps1 > ./r2-upload/install.ps1
            echo "âœ… Created install.ps1 with R2 download URL"
          else
            echo "âš ï¸ install.ps1 not found"
          fi
          
          # Copy uninstall scripts (no modification needed)
          if [ -f "agent/scripts/uninstall.sh" ]; then
            cp agent/scripts/uninstall.sh ./r2-upload/
            echo "âœ… Copied uninstall.sh"
          fi
          
          if [ -f "agent/scripts/uninstall.ps1" ]; then
            cp agent/scripts/uninstall.ps1 ./r2-upload/
            echo "âœ… Copied uninstall.ps1"
          fi
          
          # Show verification
          echo ""
          echo "ðŸ“‹ Verify install.sh download URL change:"
          grep -n "download_url=" ./r2-upload/install.sh | head -3 || true
          echo ""
          echo "ðŸ“‹ Verify install.ps1 download URL change:"
          grep -n "downloadUrl = " ./r2-upload/install.ps1 | head -3 || true

      - name: Download agent binaries from GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Downloading agent binaries from GitHub Release..."
          VERSION="${{ inputs.version }}"
          
          cd ./r2-upload
          
          # Linux x86_64
          if [[ "${{ inputs.upload_agent_linux_x64 }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading Agent Linux x86_64..."
            gh release download "v${VERSION}" \
              --pattern "nanolink-agent-linux-x86_64" \
              --repo ${{ github.repository }} || echo "âš ï¸ Agent Linux x86_64 not found"
          fi
          
          # Linux ARM64
          if [[ "${{ inputs.upload_agent_linux_arm64 }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading Agent Linux ARM64..."
            gh release download "v${VERSION}" \
              --pattern "nanolink-agent-linux-aarch64" \
              --repo ${{ github.repository }} || echo "âš ï¸ Agent Linux ARM64 not found"
          fi
          
          # macOS Intel (x86_64)
          if [[ "${{ inputs.upload_agent_macos_x64 }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading Agent macOS Intel..."
            gh release download "v${VERSION}" \
              --pattern "nanolink-agent-macos-x86_64" \
              --repo ${{ github.repository }} || echo "âš ï¸ Agent macOS Intel not found"
          fi
          
          # macOS Apple Silicon (ARM64)
          if [[ "${{ inputs.upload_agent_macos_arm64 }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading Agent macOS Apple Silicon..."
            gh release download "v${VERSION}" \
              --pattern "nanolink-agent-macos-aarch64" \
              --repo ${{ github.repository }} || echo "âš ï¸ Agent macOS Apple Silicon not found"
          fi
          
          # Windows x64
          if [[ "${{ inputs.upload_agent_windows_x64 }}" == "true" ]]; then
            echo "ðŸ“¦ Downloading Agent Windows x64..."
            gh release download "v${VERSION}" \
              --pattern "nanolink-agent-windows-x86_64.exe" \
              --repo ${{ github.repository }} || echo "âš ï¸ Agent Windows x64 not found"
          fi
          
          # List downloaded files
          echo "ðŸ“‹ Downloaded files:"
          ls -lh
          
          cd ..

      - name: Upload to Cloudflare R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "â˜ï¸ Uploading files to Cloudflare R2..."
          VERSION="${{ inputs.version }}"
          
          # Debug info
          echo "ðŸ“‹ Debug info:"
          echo "   R2_ENDPOINT: ${R2_ENDPOINT}"
          echo "   R2_BUCKET: ${R2_BUCKET}"
          echo "   VERSION: ${VERSION}"
          
          # Check if there are files to upload
          if [ -z "$(ls -A ./r2-upload 2>/dev/null)" ]; then
            echo "âš ï¸ No files to upload"
            exit 0
          fi
          
          echo "ðŸ“‚ Files to upload:"
          ls -la ./r2-upload/
          
          # Upload all files to R2
          UPLOAD_COUNT=0
          FAILED_COUNT=0
          for file in ./r2-upload/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "ðŸ“¤ Uploading: $filename ($filesize)"
              
              # Upload to R2, path format: releases/v{version}/{filename}
              if aws s3 cp "$file" \
                "s3://${R2_BUCKET}/releases/v${VERSION}/${filename}" \
                --endpoint-url "${R2_ENDPOINT}"; then
                echo "âœ… Successfully uploaded: $filename"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              else
                echo "âŒ Failed to upload: $filename"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            fi
          done
          
          echo "ðŸŽ‰ Upload completed! Total files uploaded: $UPLOAD_COUNT, Failed: $FAILED_COUNT"
          
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "âš ï¸ Some files failed to upload. Please check the logs above."
          fi

      - name: Generate download URLs and update Release notes
        if: inputs.update_release_notes == true
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”— Generating download URLs..."
          VERSION="${{ inputs.version }}"
          
          # Debug info
          echo "ðŸ“‹ Debug info:"
          echo "   R2_PUBLIC_URL: ${R2_PUBLIC_URL}"
          echo "   R2_BUCKET: ${R2_BUCKET}"
          echo "   VERSION: ${VERSION}"
          
          # Check if there are files
          if [ -z "$(ls -A ./r2-upload 2>/dev/null)" ]; then
            echo "âš ï¸ No files to generate URLs for"
            exit 0
          fi
          
          # Build base URL
          if [ -n "${R2_PUBLIC_URL}" ]; then
            R2_PUBLIC_URL="${R2_PUBLIC_URL%/}"
            if [[ "${R2_PUBLIC_URL}" =~ ^https?:// ]]; then
              base_url="${R2_PUBLIC_URL}"
            else
              base_url="https://${R2_PUBLIC_URL}"
            fi
          else
            base_url="https://${R2_BUCKET}.r2.dev"
          fi
          
          echo "ðŸ“‹ Base URL: ${base_url}"
          
          # Generate R2 URLs markdown
          echo "## â˜ï¸ Cloudflare R2 ä¸‹è½½é“¾æŽ¥ï¼ˆå›½å†…è®¿é—®ä¼˜åŒ–ï¼‰" > r2-urls.md
          echo "" >> r2-urls.md
          echo "ä»¥ä¸‹æ–‡ä»¶å·²ä¸Šä¼ åˆ° Cloudflare R2ï¼Œæä¾›æ›´å¿«çš„å›½å†…è®¿é—®é€Ÿåº¦ï¼š" >> r2-urls.md
          echo "" >> r2-urls.md
          
          # Quick Install section (R2 optimized)
          echo "### ðŸš€ å¿«é€Ÿå®‰è£…ï¼ˆæŽ¨èå›½å†…ç”¨æˆ·ä½¿ç”¨ï¼‰" >> r2-urls.md
          echo "" >> r2-urls.md
          echo "**Linux/macOS:**" >> r2-urls.md
          echo '```bash' >> r2-urls.md
          echo "curl -fsSL ${base_url}/releases/v${VERSION}/install.sh | sudo bash" >> r2-urls.md
          echo '```' >> r2-urls.md
          echo "" >> r2-urls.md
          echo "**Windows (PowerShell ç®¡ç†å‘˜):**" >> r2-urls.md
          echo '```powershell' >> r2-urls.md
          echo "irm ${base_url}/releases/v${VERSION}/install.ps1 | iex" >> r2-urls.md
          echo '```' >> r2-urls.md
          echo "" >> r2-urls.md
          
          # Install scripts section
          echo "### ðŸ“œ å®‰è£…è„šæœ¬" >> r2-urls.md
          echo "" >> r2-urls.md
          echo "| è„šæœ¬ | è¯´æ˜Ž | ä¸‹è½½é“¾æŽ¥ |" >> r2-urls.md
          echo "|------|------|----------|" >> r2-urls.md
          
          # Install scripts
          for file in ./r2-upload/install.sh ./r2-upload/install.ps1; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              url="${base_url}/releases/v${VERSION}/${filename}"
              if [[ "$filename" == *.sh ]]; then
                echo "| **${filename}** | å®‰è£…è„šæœ¬ (Linux/macOS) | [ä¸‹è½½](${url}) (${filesize}) |" >> r2-urls.md
              else
                echo "| **${filename}** | å®‰è£…è„šæœ¬ (Windows) | [ä¸‹è½½](${url}) (${filesize}) |" >> r2-urls.md
              fi
            fi
          done
          
          # Uninstall scripts
          for file in ./r2-upload/uninstall.*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              url="${base_url}/releases/v${VERSION}/${filename}"
              if [[ "$filename" == *.sh ]]; then
                echo "| ${filename} | å¸è½½è„šæœ¬ (Linux/macOS) | [ä¸‹è½½](${url}) (${filesize}) |" >> r2-urls.md
              else
                echo "| ${filename} | å¸è½½è„šæœ¬ (Windows) | [ä¸‹è½½](${url}) (${filesize}) |" >> r2-urls.md
              fi
            fi
          done
          
          echo "" >> r2-urls.md
          echo "### ðŸ”§ Agent äºŒè¿›åˆ¶æ–‡ä»¶" >> r2-urls.md
          echo "" >> r2-urls.md
          echo "| å¹³å° | æž¶æž„ | ä¸‹è½½é“¾æŽ¥ |" >> r2-urls.md
          echo "|------|------|----------|" >> r2-urls.md
          
          for file in ./r2-upload/nanolink-agent-*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              url="${base_url}/releases/v${VERSION}/${filename}"
              
              # Determine platform and architecture
              case "$filename" in
                *linux-x86_64*)
                  platform="Linux"; arch="x86_64"
                  ;;
                *linux-aarch64*)
                  platform="Linux"; arch="ARM64"
                  ;;
                *macos-x86_64*)
                  platform="macOS"; arch="Intel (x86_64)"
                  ;;
                *macos-aarch64*)
                  platform="macOS"; arch="Apple Silicon (ARM64)"
                  ;;
                *windows-x86_64*)
                  platform="Windows"; arch="x64"
                  ;;
                *)
                  platform="Unknown"; arch="Unknown"
                  ;;
              esac
              
              echo "| ${platform} | ${arch} | [${filename}](${url}) (${filesize}) |" >> r2-urls.md
            fi
          done
          
          echo "" >> r2-urls.md
          echo "---" >> r2-urls.md
          echo "" >> r2-urls.md
          
          echo "ðŸ“„ Generated r2-urls.md content:"
          cat r2-urls.md
          
          # Get current Release notes
          CURRENT_NOTES=$(gh release view "v${VERSION}" --json body -q .body --repo ${{ github.repository }})
          
          # Check if R2 links already exist
          if echo "$CURRENT_NOTES" | grep -q "Cloudflare R2"; then
            echo "âš ï¸ Release notes already contain R2 links, skipping update"
          else
            # Append R2 links to existing notes
            {
              echo "$CURRENT_NOTES"
              echo ""
              cat r2-urls.md
            } > combined-notes.md
            
            # Update Release notes
            gh release edit "v${VERSION}" \
              --notes-file combined-notes.md \
              --repo ${{ github.repository }}
            
            echo "âœ… Release notes updated with R2 download links"
          fi
